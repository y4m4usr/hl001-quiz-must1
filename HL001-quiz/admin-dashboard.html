<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HL001 ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    .container { max-width: 1600px; margin: 0 auto; }
    .header {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    h1 {
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 32px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .subtitle { color: #7f8c8d; font-size: 16px; }

    /* æœŸé–“é¸æŠãƒœã‚¿ãƒ³ */
    .period-selector {
      background: white;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    .period-btn {
      padding: 12px 24px;
      border: 2px solid #667eea;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      color: #667eea;
    }
    .period-btn:hover {
      background: #f0f4ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    .period-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #764ba2;
    }

    /* ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .summary-card {
      background: white;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    .summary-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }
    .summary-card .icon {
      font-size: 36px;
      margin-bottom: 10px;
    }
    .summary-card .label {
      color: #7f8c8d;
      font-size: 14px;
      margin-bottom: 8px;
    }
    .summary-card .value {
      color: #2c3e50;
      font-size: 32px;
      font-weight: bold;
    }
    .summary-card .sub-value {
      color: #95a5a6;
      font-size: 14px;
      margin-top: 8px;
    }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .section {
      background: white;
      padding: 35px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .section-title {
      font-size: 24px;
      color: #2c3e50;
      margin-bottom: 25px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    .table-container {
      overflow-x: auto;
      max-height: 500px;
      overflow-y: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #2c3e50;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    tr:hover {
      background: #f8f9fa;
    }
    .rank-1 {
      background: linear-gradient(135deg, #fff9e6 0%, #ffe8b3 100%);
      font-weight: bold;
    }
    .rank-2 {
      background: linear-gradient(135deg, #f0f4ff 0%, #d9e5ff 100%);
    }
    .rank-3 {
      background: linear-gradient(135deg, #fff0f0 0%, #ffd9d9 100%);
    }

    /* ãƒãƒƒã‚¸ */
    .badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }
    .badge-score {
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      color: #2e7d32;
    }
    .badge-plays {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      color: #1565c0;
    }
    .badge-accuracy {
      background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%);
      color: #c2185b;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      text-align: center;
      padding: 80px;
      font-size: 20px;
      color: white;
      background: rgba(255,255,255,0.1);
      border-radius: 16px;
      backdrop-filter: blur(10px);
    }
    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .grid-2col {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 30px;
      margin-bottom: 30px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><span>ğŸ“Š</span>ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <div class="subtitle" id="periodLabel">æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...
    </div>

    <div id="mainContent" style="display:none;">
      <!-- æœŸé–“é¸æŠãƒœã‚¿ãƒ³ -->
      <div class="period-selector">
        <button class="period-btn" data-period="weekly">é€±æ¬¡</button>
        <button class="period-btn active" data-period="monthly">æœˆæ¬¡</button>
        <button class="period-btn" data-period="yearly">å¹´æ¬¡</button>
        <button class="period-btn" data-period="all">ç´¯è¨ˆ</button>
      </div>

      <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
      <div class="summary-grid">
        <div class="summary-card">
          <div class="icon">ğŸ‘¥</div>
          <div class="label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
          <div class="value" id="activeUsers">-</div>
          <div class="sub-value">å…¨ä½“: <span id="totalUsers">-</span>äºº</div>
        </div>
        <div class="summary-card">
          <div class="icon">ğŸ¯</div>
          <div class="label">ç·ãƒ—ãƒ¬ã‚¤å›æ•°</div>
          <div class="value" id="totalPlays">-</div>
          <div class="sub-value">æœ¬ç•ª: <span id="dailyPlays">-</span> / ç·´ç¿’: <span id="practicePlays">-</span></div>
        </div>
        <div class="summary-card">
          <div class="icon">â­</div>
          <div class="label">å¹³å‡ã‚¹ã‚³ã‚¢</div>
          <div class="value" id="avgScore">-</div>
          <div class="sub-value">å¹³å‡æ­£ç­”ç‡: <span id="avgAccuracy">-</span>%</div>
        </div>
        <div class="summary-card">
          <div class="icon">âš¡</div>
          <div class="label">å¹³å‡ã‚¿ã‚¤ãƒ ãƒœãƒ¼ãƒŠã‚¹</div>
          <div class="value" id="avgTimeBonus">-</div>
          <div class="sub-value">ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒ­ã‚°ã‚¤ãƒ³: <span id="uniqueLogins">-</span></div>
        </div>
      </div>

      <div class="grid-2col">
        <!-- åº—èˆ—åˆ¥çµ±è¨ˆ -->
        <div class="section">
          <div class="section-title">ğŸª åº—èˆ—åˆ¥çµ±è¨ˆ TOP5</div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>é †ä½</th>
                  <th>åº—èˆ—</th>
                  <th>æ´»å‹•ç‡</th>
                  <th>å¹³å‡ã‚¹ã‚³ã‚¢</th>
                </tr>
              </thead>
              <tbody id="storeStatsBody"></tbody>
            </table>
          </div>
        </div>

        <!-- é›£æ˜“åº¦ã®é«˜ã„å•é¡Œ -->
        <div class="section">
          <div class="section-title">â“ é›£æ˜“åº¦ã®é«˜ã„å•é¡Œ TOP5</div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>é †ä½</th>
                  <th>å•é¡ŒID</th>
                  <th>æ­£ç­”ç‡</th>
                  <th>æŒ‘æˆ¦å›æ•°</th>
                </tr>
              </thead>
              <tbody id="questionAnalysisBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
      <div class="section">
        <div class="section-title">ğŸ† ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP20</div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>é †ä½</th>
                <th>æ°å</th>
                <th>æ‰€å±</th>
                <th>ãƒ—ãƒ¬ã‚¤æ•°</th>
                <th>å¹³å‡ã‚¹ã‚³ã‚¢</th>
                <th>ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢</th>
                <th>æ­£ç­”ç‡</th>
                <th>é€£ç¶šæ—¥æ•°</th>
              </tr>
            </thead>
            <tbody id="userAnalyticsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentPeriod = 'monthly';

    // æœŸé–“é¸æŠãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    document.querySelectorAll('.period-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentPeriod = this.dataset.period;
        loadDashboard();
      });
    });

    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    async function fetchDashboardSummary(period) {
      try {
        const response = await fetch('<?!= getScriptUrl() ?>?action=getDashboardSummary&period=' + period);
        if (!response.ok) throw new Error('ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—');
        return await response.json();
      } catch (error) {
        console.error('Error:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n' + error.message);
        return null;
      }
    }

    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°
    async function loadDashboard() {
      const data = await fetchDashboardSummary(currentPeriod);
      if (!data || !data.success) {
        alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data ? data.error : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        return;
      }

      // æœŸé–“ãƒ©ãƒ™ãƒ«æ›´æ–°
      if (data.summary) {
        document.getElementById('periodLabel').textContent = data.summary.periodLabel + ' ã®çµ±è¨ˆ';
      }

      // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰æ›´æ–°
      updateSummaryCards(data.summary);

      // åº—èˆ—åˆ¥çµ±è¨ˆæ›´æ–°
      updateStoreStats(data.storeStats);

      // å•é¡Œåˆ†ææ›´æ–°
      updateQuestionAnalysis(data.questionAnalysis);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°
      updateUserAnalytics(data.userAnalytics);
    }

    // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰æ›´æ–°
    function updateSummaryCards(summary) {
      if (!summary) return;
      document.getElementById('activeUsers').textContent = summary.activeUsers || 0;
      document.getElementById('totalUsers').textContent = summary.totalUsers || 0;
      document.getElementById('totalPlays').textContent = summary.totalPlays || 0;
      document.getElementById('dailyPlays').textContent = summary.dailyPlays || 0;
      document.getElementById('practicePlays').textContent = summary.practicePlays || 0;
      document.getElementById('avgScore').textContent = (summary.avgScore || 0).toFixed(1);
      document.getElementById('avgAccuracy').textContent = (summary.avgAccuracy || 0).toFixed(1);
      document.getElementById('avgTimeBonus').textContent = (summary.avgTimeBonus || 0).toFixed(1);
      document.getElementById('uniqueLogins').textContent = summary.uniqueLogins || 0;
    }

    // åº—èˆ—åˆ¥çµ±è¨ˆæ›´æ–°
    function updateStoreStats(storeStats) {
      const tbody = document.getElementById('storeStatsBody');
      tbody.innerHTML = '';

      storeStats.slice(0, 5).forEach((store, idx) => {
        const tr = document.createElement('tr');
        if (idx === 0) tr.className = 'rank-1';
        else if (idx === 1) tr.className = 'rank-2';
        else if (idx === 2) tr.className = 'rank-3';

        const medal = idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : '';
        tr.innerHTML = `
          <td>${medal} <strong>${store.rank}</strong></td>
          <td><strong>${store.store}</strong></td>
          <td><span class="badge badge-plays">${store.activeRate.toFixed(1)}%</span> (${store.activeUsers}/${store.totalUsers})</td>
          <td><span class="badge badge-score">${store.avgScore.toFixed(1)}ç‚¹</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // å•é¡Œåˆ†ææ›´æ–°
    function updateQuestionAnalysis(questionAnalysis) {
      const tbody = document.getElementById('questionAnalysisBody');
      tbody.innerHTML = '';

      questionAnalysis.slice(0, 5).forEach((question, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${question.rank}</strong></td>
          <td>${question.questionId}</td>
          <td><span class="badge badge-accuracy">${question.accuracyRate.toFixed(1)}%</span></td>
          <td>${question.totalAttempts}å›</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°
    function updateUserAnalytics(userAnalytics) {
      const tbody = document.getElementById('userAnalyticsBody');
      tbody.innerHTML = '';

      userAnalytics.forEach((user, idx) => {
        const tr = document.createElement('tr');
        if (idx === 0) tr.className = 'rank-1';
        else if (idx === 1) tr.className = 'rank-2';
        else if (idx === 2) tr.className = 'rank-3';

        const medal = idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : '';
        tr.innerHTML = `
          <td>${medal} <strong>${user.rank}</strong></td>
          <td><strong>${user.name}</strong></td>
          <td>${user.store}</td>
          <td><span class="badge badge-plays">${user.totalPlays}å›</span></td>
          <td><span class="badge badge-score">${user.avgScore.toFixed(1)}ç‚¹</span></td>
          <td>${user.bestScore}ç‚¹</td>
          <td>${user.avgAccuracy.toFixed(1)}%</td>
          <td>${user.streak}æ—¥</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // åˆæœŸåŒ–
    async function init() {
      await loadDashboard();
      document.getElementById('loading').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
