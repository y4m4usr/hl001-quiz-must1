# 管理者ダッシュボード デプロイ手順書

## 📋 概要
管理者ダッシュボード（累計機能付き）のデプロイと動作確認手順です。

---

## 🚀 ステップ1: GASにファイルをアップロード

### 1.1 Google Apps Scriptエディタを開く
1. Google Drive で対象のスプレッドシート（DASHBOARD）を開く
2. **拡張機能** > **Apps Script** をクリック

### 1.2 新しいファイルを追加
以下の3つのファイルがプロジェクトに存在することを確認：

#### ✅ 必須ファイル
- `Router.gs` (更新済み)
- `DashboardAPI.gs` (更新済み)
- `DashboardAggregation.gs` (既存・'all'対応済み)
- `admin-dashboard.html` (新規作成)

#### ファイルの追加方法
1. GASエディタで **+** ボタン > **HTML** を選択
2. ファイル名を `admin-dashboard` に変更
3. ローカルの `admin-dashboard.html` の内容をコピー&ペースト
4. 保存（Ctrl+S / Cmd+S）

---

## 🔧 ステップ2: データ集計の実行

### 2.1 全期間のデータを集計
1. GASエディタで `DashboardAggregation.gs` を開く
2. 関数選択ドロップダウンから **`updateAllPeriods`** を選択
3. **実行** ボタン（▶️）をクリック
4. 初回実行時は承認が必要な場合があります
   - 「権限を確認」をクリック
   - Googleアカウントを選択
   - 「詳細」> 「(プロジェクト名)に移動」をクリック
   - 「許可」をクリック

**実行結果の確認:**
- ログに以下が表示されればOK:
```
=== 全期間集計開始 ===
--- weeklyの集計 ---
✅ DASHBOARD_SUMMARY更新完了: xx/xxユーザー, xxプレイ
...
--- allの集計 ---
✅ DASHBOARD_SUMMARY更新完了: xx/xxユーザー, xxプレイ
=== ✅ 全期間集計完了 ===
```

### 2.2 累計期間のテスト
1. 関数選択ドロップダウンから **`testAllPeriod`** を選択
2. **実行** ボタン（▶️）をクリック
3. ログに以下が表示されればOK:
```
=== 累計テスト ===
{
  "success": true,
  "period": "all",
  "data": [...]
}
✅ 累計期間の集計が成功しました
期間ラベル: 累計
```

---

## 📦 ステップ3: Webアプリとしてデプロイ

### 3.1 新しいデプロイを作成
1. GASエディタ右上の **デプロイ** > **新しいデプロイ** をクリック
2. 設定項目:
   - **種類の選択**: 「ウェブアプリ」を選択
   - **説明**: 「管理者ダッシュボード v1.0（累計対応）」
   - **次のユーザーとして実行**: 「自分」を選択
   - **アクセスできるユーザー**: 「全員」または「組織内のユーザー」を選択
3. **デプロイ** ボタンをクリック
4. **ウェブアプリのURL** をコピー（例: `https://script.google.com/macros/s/ABC.../exec`）

### 3.2 既存デプロイを更新する場合
1. **デプロイ** > **デプロイを管理** をクリック
2. 既存のデプロイの **編集アイコン** をクリック
3. **新しいバージョン** を選択
4. **デプロイ** をクリック

---

## 🌐 ステップ4: ダッシュボードにアクセス

### 4.1 管理者ダッシュボードを開く
デプロイしたURLに `?page=admin-dashboard` を追加してアクセス:

```
https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec?page=admin-dashboard
```

### 4.2 動作確認
1. ページが正しく表示されることを確認
2. 期間選択ボタンが表示されることを確認:
   - ✅ 週次
   - ✅ 月次（デフォルト選択）
   - ✅ 年次
   - ✅ **累計** 👈 新機能
3. 各期間ボタンをクリックして、データが切り替わることを確認

### 4.3 累計データの確認
1. **「累計」ボタン** をクリック
2. 以下が表示されることを確認:
   - サマリーカードに全期間の統計
   - 期間ラベルが「累計 の統計」
   - 店舗別統計 TOP5
   - 難易度の高い問題 TOP5
   - ユーザーランキング TOP20

---

## 🧪 ステップ5: トラブルシューティング

### エラー: 「データの取得に失敗しました」
**原因**: データがまだ集計されていない
**解決策**: ステップ2を再実行して、`updateAllPeriods()` を実行

### エラー: 「DASHBOARD_SUMMARYシートが見つかりません」
**原因**: ダッシュボードシートが作成されていない
**解決策**:
1. `DashboardSheetCreator.gs` を開く
2. `createAllDashboardSheets()` を実行
3. ステップ2を再実行

### 期間ボタンをクリックしてもデータが表示されない
**原因**: 該当期間のデータが存在しない
**解決策**:
1. GASエディタで `updateAllPeriods()` を再実行
2. ログを確認して、すべての期間が正常に集計されたことを確認

### ブラウザのデベロッパーツールでエラーを確認
1. F12キーを押してデベロッパーツールを開く
2. **Console** タブでエラーメッセージを確認
3. **Network** タブでAPI呼び出しの応答を確認

---

## 📝 定期実行の設定（オプション）

データを自動で更新する場合は、トリガーを設定します。

### トリガーの設定方法
1. GASエディタ左側の **トリガー** アイコン（時計マーク）をクリック
2. **トリガーを追加** をクリック
3. 設定:
   - **実行する関数**: `updateAllPeriods`
   - **イベントのソース**: 時間主導型
   - **時間ベースのトリガーのタイプ**: 日付ベースのタイマー
   - **時刻**: 午前1時～2時（任意）
4. **保存** をクリック

これで毎日自動的に全期間のデータが更新されます。

---

## 🎉 完了！

これで管理者ダッシュボード（累計機能付き）のデプロイが完了しました。

### アクセスURL一覧
- **ログイン画面**: `https://script.google.com/.../exec`
- **努力度ダッシュボード**: `https://script.google.com/.../exec?page=dashboard`
- **管理者ダッシュボード**: `https://script.google.com/.../exec?page=admin-dashboard`

### 次のステップ
- 社内ポータルやブックマークにURLを登録
- 定期実行トリガーを設定して自動更新
- ユーザーからのフィードバックを収集して改善
