// filename: HistoryAPI.gs

/**
 * クイズ結果をHISTORYシートに保存
 * @param {Object} data - 保存するクイズデータ
 * @return {Object}
 */
function saveQuizHistory(data) {
  try {
    // 呼び出し側が {data: {...}} を渡すケースに対応
    var payload = (data && data.userId) ? data : (data && data.data) ? data.data : null;
    if (!payload) {
      throw new Error('不正なデータ形式です');
    }

    var ss = SpreadsheetApp.openById(CONFIG.SHEET_IDS.HISTORY);
    var sheet = ss.getSheetByName('history')
             || ss.getSheetByName('HISTORY')
             || ss.getSheetByName('quiz_history')
             || ss.getSheetByName('QUIZ_HISTORY')
             || ss.getSheets()[0];
    if (!sheet) throw new Error('HISTORY内の履歴シートが見つかりません');

    var timestamp = new Date();
    var total = Number(payload.total || 0);
    var correct = Number(payload.correct || 0);
    var accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;

    sheet.appendRow([
      timestamp,                // A: timestamp
      String(payload.userId || ''),      // B: userId
      String(payload.userName || ''),    // C: userName
      String(payload.store || ''),       // D: store
      String(payload.mode || 'practice'),// E: mode
      Number(payload.score || 0),        // F: score
      correct,                           // G: correct
      total,                             // H: total
      accuracy,                          // I: accuracy
      Number(payload.totalHintsUsed || 0), // J: totalHintsUsed
      Number(payload.timeSec || 0)       // K: timeSec
    ]);

    // ランキング更新
    updateRankingsFromHistory(String(payload.userId || ''));

    return { success: true, message: '結果を保存しました' };
  } catch (error) {
    Logger.log('saveQuizHistory エラー: ' + error.message);
    return { success: false, message: 'データ保存に失敗しました', error: error.message };
  }
}

/**
 * v11互換: フロントから送られる結果を受け取り、既存フォーマットで保存
 * - 既存の saveQuizHistory に委譲してシート構造との整合性を保つ
 * @param {Object} data
 * @return {Object}
 */
function submitQuizAnswers(data) {
  try {
    // 受け取り形式のゆらぎに対応（オブジェクト/ラップ/JSON文字列）
    let payload = null;
    if (data) {
      if (typeof data === 'string') {
        try { payload = JSON.parse(data); } catch(_) { payload = null; }
      } else if (data.userId) {
        payload = data;
      } else if (data.data) {
        if (typeof data.data === 'string') {
          try { payload = JSON.parse(data.data); } catch(_) { payload = null; }
        } else {
          payload = data.data;
        }
      }
    }
    if (!payload || !payload.userId) throw new Error('不正なデータ形式です');

    const ss = SpreadsheetApp.openById(CONFIG.SHEET_IDS.HISTORY);
    const sheet = ss.getSheetByName('history')
                 || ss.getSheetByName('HISTORY')
                 || ss.getSheetByName('quiz_history')
                 || ss.getSheetByName('QUIZ_HISTORY')
                 || ss.getSheets()[0];
    if (!sheet) throw new Error('HISTORY内の履歴シートが見つかりません');

    const timestamp = new Date();
    const historyId = 'HIS_' + Utilities.formatDate(timestamp, 'Asia/Tokyo', 'yyyyMMdd_HHmmss') + '_' + String(payload.userId || '');

    const answers = Array.isArray(payload.answers) ? payload.answers : [];
    // derive metrics if not provided
    const totalQuestions = answers.length;
    var correctCount = 0;
    var bonusPointsCalc = 0;
    var totalTimeSpent = 0;
    answers.forEach(function(a){
      if (a && a.isCorrect) correctCount++;
      var hu = Number(a && a.hintsUsed || 0);
      if (hu === 0) bonusPointsCalc += 10; else if (hu === 1) bonusPointsCalc += 5;
      totalTimeSpent += Number(a && a.timeSpent || 0);
    });
    var accuracyCalc = totalQuestions > 0 ? Math.round((correctCount / totalQuestions) * 100) : 0;
    var timeBonusCalc = Math.max(0, 200 - totalTimeSpent);
    var metaAccuracy = Number(payload.accuracy != null ? payload.accuracy : accuracyCalc);
    var metaBonus = Number(payload.bonusPoints != null ? payload.bonusPoints : bonusPointsCalc);
    var metaTime = Number(payload.timeBonus != null ? payload.timeBonus : timeBonusCalc);
    var totalScoreCalc = Number(payload.score != null ? payload.score : (metaAccuracy + metaBonus + metaTime));
    Logger.log('submitQuizAnswers received: user=' + String(payload.userId||'') + ', mode=' + String(payload.mode||'') + ', answers=' + answers.length);
    answers.forEach((ans, idx) => {
      sheet.appendRow([
        historyId,                                 // A: historyId
        timestamp,                                 // B: timestamp
        String(payload.userId || ''),              // C: userId
        String(payload.mode || 'practice'),        // D: mode
        String(ans.questionId || 'Q' + (idx+1)),   // E: questionId
        String(ans.userAnswer || ans.selected || ''), // F: userAnswer
        ans.isCorrect ? true : false,              // G: isCorrect
        Number(ans.hintsUsed || 0),                // H: hintsUsed
        Number(ans.timeSpent || 0),                // I: timeSpent
        Number(ans.score || 0),                    // J: score（この行のスコア）
        Number(totalScoreCalc || 0),               // K: totalScore
        JSON.stringify({                           // L: metadata(JSON)
          bonusPoints: metaBonus || 0,
          timeBonus: metaTime || 0,
          accuracy: metaAccuracy || 0
        })
      ]);
    });

    // duplicate submit guard AFTER successful write
    try {
      var cache = CacheService.getScriptCache();
      var guardKey = 'submitGuard_' + String(payload.userId || '');
      cache.put(guardKey, '1', 10);
    } catch (eGuard2) {
      try { Logger.log('submitQuizAnswers guard set err: ' + eGuard2.message); } catch(_){ }
    }

    // USERSシートに累計回数/最終本番日を記録（存在すれば）
    try { updateUserPracticeCount(payload.userId, payload.mode); } catch (e2) { try{ Logger.log(e2.message || e2);}catch(_){}}

    // RANKINGS（新版）を更新（自己ベストのみ上書き）
    try {
      // ランキング更新用の最小ペイロードを組み立て（不足分は計算値）
      var rankPayload = {
        userId: String(payload.userId || ''),
        score: Number(totalScoreCalc || 0),
        accuracy: Number(metaAccuracy || 0),
        bonusPoints: Number(metaBonus || 0),
        timeBonus: Number(metaTime || 0)
      };
      if (rankPayload.userId) updateRankings(rankPayload);
    } catch (e3) { try{ Logger.log('updateRankings err: ' + (e3 && e3.message || e3)); }catch(_){}}

    return { success: true, message: '結果を保存しました', historyId: historyId };
  } catch (e) {
    Logger.log('submitQuizAnswers エラー: ' + e.message);
    return { success: false, message: 'データ保存に失敗しました', error: e.message };
  }
}

function updateUserPracticeCount(userId, mode) {
  try {
    const ss = SpreadsheetApp.openById(CONFIG.SHEET_IDS.USERS);
    // 既存は 'users' シート名のため両対応
    const sheet = ss.getSheetByName('USERS') || ss.getSheetByName('users');
    if (!sheet) return;
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][0]) === String(userId)) {
        const currentPractice = Number(data[i][6] || 0); // G: totalPractice
        const currentDaily = Number(data[i][7] || 0);    // H: totalDaily
        if (String(mode || 'practice') === 'practice') {
          sheet.getRange(i + 1, 7).setValue(currentPractice + 1);
        } else {
          sheet.getRange(i + 1, 8).setValue(currentDaily + 1);
          sheet.getRange(i + 1, 9).setValue(new Date()); // I: lastDailyDate
        }
        break;
      }
    }
  } catch (error) {
    Logger.log('updateUserPracticeCount エラー: ' + error.message);
  }
}

/**
 * RANKINGS（新版）更新
 * - 列: A userId, B userName, C store, D bestTotalScore, E bestAccuracy,
 *       F bestBonusPoints, G bestTimeBonus, H totalPractice, I totalDaily, J lastPlayed
 */
function updateRankings(payload) {
  try {
    if (!payload || !payload.userId) {
      try { Logger.log('updateRankings skip: invalid payload'); } catch (_){ }
      return;
    }
    var rankingsSs = SpreadsheetApp.openById(CONFIG.SHEET_IDS.RANKINGS);
    var rankingsSheet = rankingsSs.getSheetByName('rankings');
    if (!rankingsSheet) throw new Error('rankingsシートが見つかりません');

    var userId = payload.userId;
    var totalScore = Number(payload.score || 0);
    var accuracy = Number(payload.accuracy || 0);
    var bonusPoints = Number(payload.bonusPoints || 0);
    var timeBonus = Number(payload.timeBonus || 0);

    // USERSシートから追加情報取得
    var usersSs = SpreadsheetApp.openById(CONFIG.SHEET_IDS.USERS);
    var usersSheet = usersSs.getSheetByName('USERS') || usersSs.getSheetByName('users');
    var usersData = usersSheet ? usersSheet.getDataRange().getValues() : [];

    var userName = userId;
    var store = '';
    var totalPractice = 0;
    var totalDaily = 0;

    for (var i = 1; i < usersData.length; i++) {
      if (String(usersData[i][0]) === String(userId)) {
        userName = usersData[i][1];
        store = usersData[i][2];
        totalPractice = Number(usersData[i][6] || 0);
        totalDaily = Number(usersData[i][7] || 0);
        break;
      }
    }

    // 既存のランキングデータ取得
    var rankingsData = rankingsSheet.getDataRange().getValues();
    var rowIndex = -1;
    var currentBest = 0;

    for (var r = 1; r < rankingsData.length; r++) {
      if (String(rankingsData[r][0]) === String(userId)) {
        rowIndex = r + 1; // 1-based
        currentBest = Number(rankingsData[r][3] || 0); // D: bestTotalScore
        break;
      }
    }

    var rowData = [
      userId,
      userName,
      store,
      totalScore,
      accuracy,
      bonusPoints,
      timeBonus,
      totalPractice,
      totalDaily,
      new Date()
    ];

    // 自己ベスト更新時は全列上書き、未更新でも H～J を更新
    if (totalScore > currentBest) {
      if (rowIndex > 0) {
        rankingsSheet.getRange(rowIndex, 1, 1, 10).setValues([rowData]);
      } else {
        rankingsSheet.appendRow(rowData);
      }
    } else if (rowIndex > 0) {
      rankingsSheet.getRange(rowIndex, 8, 1, 3).setValues([[totalPractice, totalDaily, new Date()]]);
    }
  } catch (error) {
    try { Logger.log('updateRankings エラー: ' + error.message); } catch(_) {}
  }
}

/**
 * ランキングを更新（ユーザーの平均スコア/正答率など）
 * @param {string} userId
 */
function updateRankingsFromHistory(userId) {
  try {
    if (!userId) return;

    var historySs = SpreadsheetApp.openById(CONFIG.SHEET_IDS.HISTORY);
    var historySheet = historySs.getSheetByName('history')
                   || historySs.getSheetByName('HISTORY')
                   || historySs.getSheetByName('quiz_history')
                   || historySs.getSheetByName('QUIZ_HISTORY')
                   || historySs.getSheets()[0];
    var rankingsSs = SpreadsheetApp.openById(CONFIG.SHEET_IDS.RANKINGS);
    var rankingsSheet = rankingsSs.getSheetByName('rankings');
    if (!historySheet || !rankingsSheet) throw new Error('シートが見つかりません');

    var historyData = historySheet.getDataRange().getValues();
    var userHistory = [];
    for (var i = 1; i < historyData.length; i++) {
      if (String(historyData[i][1]) === String(userId)) userHistory.push(historyData[i]); // B列 userId
    }
    if (userHistory.length === 0) return;

    var totalScore = 0, totalAcc = 0;
    for (var j = 0; j < userHistory.length; j++) {
      totalScore += Number(userHistory[j][5] || 0); // F score
      totalAcc += Number(userHistory[j][8] || 0);   // I accuracy
    }
    var avgScore = Math.round(totalScore / userHistory.length);
    var avgAccuracy = Math.round(totalAcc / userHistory.length);
    var playCount = userHistory.length;
    var lastPlayed = userHistory[userHistory.length - 1][0]; // A timestamp
    var userName = userHistory[0][2];
    var store = userHistory[0][3];

    var rankingsData = rankingsSheet.getDataRange().getValues();
    var rowIndex = -1;
    for (var r = 1; r < rankingsData.length; r++) {
      if (String(rankingsData[r][0]) === String(userId)) { // A userId
        rowIndex = r + 1; // 1-based
        break;
      }
    }

    var rowData = [userId, userName, store, avgScore, avgAccuracy, playCount, lastPlayed];
    if (rowIndex > 0) {
      rankingsSheet.getRange(rowIndex, 1, 1, 7).setValues([rowData]);
    } else {
      rankingsSheet.appendRow(rowData);
    }
  } catch (error) {
    Logger.log('updateRankings エラー: ' + error.message);
  }
}

